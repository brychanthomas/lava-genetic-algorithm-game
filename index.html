<!DOCTYPE html>
<html>
<head>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.20.0/dist/phaser.js"></script>
</head>
<body>

<script>

class Lava {
  constructor(y, game) {
    this.image1 = game.add.image(Math.floor(Math.random() * 401)-200, y, 'lava1');
    this.image1.setScale(6);
    this.image2 = game.add.image(this.image1.x+this.image1.displayWidth, y, 'lava2');
    this.image2.setScale(6);
    this.rockImage = game.add.image(Math.floor(Math.random() * 401), y, 'rock');
    this.rockImage.setScale(6);
    this.speed = 6;
    this._activated = true;
    this.game = game;
  }

  //move the lava
  update() {
    if (this._activated) {
    //move both sprites right
      this.image1.x = this.image1.x + this.speed;
      this.image2.x = this.image2.x + this.speed;
      //if one sprite is beyond visible edge, move it to the other side
      if (this.image1.x-(this.image1.displayWidth/2) > 400) {
        this.image1.x = this.image2.x-this.image1.displayWidth;
      } else if (this.image2.x-(this.image2.displayWidth/2) > 400) {
        this.image2.x = this.image1.x-this.image2.displayWidth;
      }
      //move rock
      this.rockImage.x = this.rockImage.x + this.speed;
      //if rock beyond visible edge move it to the other side
      if (this.rockImage.x - (this.rockImage.displayWidth/2) > 400) {
        this.rockImage.x = -this.rockImage.displayWidth/2 - Math.floor(Math.random() * 301);
      }
    }
    //if it's off the bottom edge of the screen
    if (this.y - this.image1.displayHeight/2 > this.game.cameras.main.midPoint.y+300) {
      this.y = this.game.cameras.main.midPoint.y - 360;
      return true; //return true if moved from bottom to top (so active state can be randomised)
    }
    return false;
  }

  //check if it is safe for the player to stand on the lava
  //(whether the rock is under their x coordinate)
  checkIfSafe() {
    if (200 > this.rockImage.x-this.rockImage.displayWidth/2 && 200 < this.rockImage.x+this.rockImage.displayWidth/2) {
      return true
    }
    return false || !this._activated;
  }

  set activated(active) {
    active = Boolean(active);
    this.rockImage.visible = active;
    this.image1.visible = active;
    this.image2.visible = active;
    this._activated = active;
  }

  get activated() {
    return this._activated;
  }

  set y(y) {
    this.image1.y = y;
    this.image2.y = y;
    this.rockImage.y = y;
  }

  get y() {
    return this.image1.y;
  }
}

class Player {
  constructor(game) {
    this.sprite = game.physics.add.sprite(200, 420, 'circle');
    this.sprite.setScale(0.4); //make it appear smaller
    this.sprite.depth = 9;
    this.game = game;
    this.dead = false;
  }

  moveUp() {
    if (!this.dead) {
      this.sprite.y -= 60;
    }
  }

  get y() {
    return this.sprite.y;
  }

  get x() {
    return this.sprite.x;
  }

}

var config = { //create configuration for game
  type: Phaser.CANVAS,
  width: 400, //size of window
  height: 600,
  pixelArt: true,
  physics: {
    default: 'arcade', //the physics engine the game will use
    arcade: {
      debug: true
    }
  },
  scene: {
    preload: preload,
    create: create,
    update: update
  }
};

var game = new Phaser.Game(config); //create the game object

//initialise global variables
var player;
var lavaSlots = []; //list to store the 10 lava objects
var dead = false;
var gameOverText;

function preload () { //this function loads images before the game starts
  //each image is given a name that is used to refer to it later on
  this.load.image('circle', 'assets/circle.png');
  this.load.image('lava1', 'assets/lava1.png');
  this.load.image('lava2', 'assets/lava2.png');
  this.load.image('rock', 'assets/rock.png');
}

function create () { //this function creates sprites at the start of the game
  player = new Player(this);

  gameOverText = this.add.text(50, 300, 'GAME OVER\nPress R to respawn', { fontFamily: 'Arial', fontSize: 35, align: 'center'});
  gameOverText.depth = 10;
  gameOverText.visible = false;

  this.cameras.main.setBackgroundColor('#99ff66');

  this.input.keyboard.on('keydown-SPACE', player.moveUp.bind(player));
  this.input.keyboard.on('keydown-R', restart);

  //create the lava objects
  lavaSlots.push(new Lava(-60, this));
  for (let y=0; y<=600; y=y+60) {
    lavaSlots.push(new Lava(y, this));
    console.log(y, lavaSlots.length-1);
    lavaSlots[lavaSlots.length-1].activated = Math.random() >= 0.5;
    if (lavaSlots[lavaSlots.length-2].activated) {
      lavaSlots[lavaSlots.length-1].activated = false;
    }
  }
  lavaSlots[8].activated = false; //deactivate lava where player spawns

}

function update () { //this function runs every frame
  if (!player.dead) {
    lavaSlots.forEach(function(lava, index) {
      let movedToTop = lava.update();
      if (movedToTop) {
        lava.activated = Math.random() >= 0.5;
        if (lavaSlots[(index+1) % 12].activated) {
          //if neighbour is activated, deactivate
          lava.activated = false;
        }
      }
      if (player.y === lava.y) {
        if (!lava.checkIfSafe()) {
          player.dead = true;
        }
      }
    });
  } else {
    gameOverText.y = this.cameras.main.midPoint.y;
    gameOverText.visible = true;
  }
  this.cameras.main.centerOn(player.x, player.y-180);
}

function restart() {
  lavaSlots[0].activated = false;
  for (let i=1; i<lavaSlots.length; i++) {
    lavaSlots[i].activated = Math.random() >= 0.5;
    if (lavaSlots[i-1].activated) {
      lavaSlots[i].activated = false;
    }
    if (lavaSlots[i].y === player.y) {
      lavaSlots[i].activated = false;
    }
  }
  player.dead = false;
  gameOverText.visible = false;
}

</script>
</body>
</html>
